<%- include("../partials/_navbar.ejs") %>

<h1>Blog Details</h1>

<div>
  <div>
    <img src="<%= blog.owner.image %>" alt="profile picture" width="50">
    <p><%= blog.owner.username %></p>
    <p>Created at: <%= blog.createdAt.toLocaleString() %></p>
  </div>

  <h3>Favorited by <%= blog.favoritedByUsers.length %> people</h3>
  <% if (user) { %>
    <% if (userHasFavorited) { %>
      <form action="/blogs/<%= blog._id %>/favorited-by/<%= user._id %>?_method=DELETE" method="post">
        <button type="submit">Unfavorite</button>
      </form>
    <% } else { %>
      <form action="/blogs/<%= blog._id %>/favorited-by/<%= user._id %>" method="post">
        <button type="submit">Favorite</button>
      </form>
    <% } %>
  <% } %>

  <p>Description: <%= blog.description %></p>

  <% if (blog.images && blog.images.length > 0) { %>
    <% blog.images.forEach(img => { %>
      <img src="/<%= img %>" width="200">
    <% }) %>
  <% } %>

  <% if (blog.video) { %>
    <video controls width="300">
      <source src="/<%= blog.video %>" type="video/mp4">
    </video>
  <% } %>
</div>

<h2>Comments</h2>

<form action="/comments/<%= blog._id %>" method="POST">
  <textarea name="message" placeholder="comment here....." required></textarea>
  <button type="submit">Submit</button>
</form>

<div>
  <% if (comments.length === 0) { %>
    <p>No comments yet.</p>
  <% } else { %>
    <% comments.forEach(comment => { %>
      <div>
        <p><%= comment.owner.username %> - <%= comment.createdAt.toLocaleString() %></p>
        <p><%= comment.message %></p>

        <% if( user && user._id.toString() === comment.owner._id.toString() ) { %>
          <form action="/comments/<%= comment._id %>?_method=PUT" method="POST">
            <input type="text" name="message" value="<%= comment.message %>" required>
            <button type="submit">Edit</button>
          </form>
        <% } %>
      </div>
    <% }) %>
  <% } %>
</div>
